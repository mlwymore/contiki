<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>EMMA: E.M.M.A Network example tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>E.M.M.A Network example tutorial</h1>
<p>E.M.M.A Network example tutorial shows a network example with a proxy system on a simple web page PHP, two nodes and a website for data reading using javascript High Charts Framework.  
<a href="#_details">More...</a></p>
<table border="0" cellpadding="0" cellspacing="0">
</table>
<p>E.M.M.A Network example tutorial shows a network example with a proxy system on a simple web page PHP, two nodes and a website for data reading using javascript High Charts Framework. </p>
<h2><a class="anchor" id="overview">
EmmaNetwork Overview</a></h2>
<p>The network is separated in two main space, the speed Internet and the slow (6loWPAN) network. To avoid network congestion on a node of the 6lowPAN like the gateway, the proxy is localised directly on the Internet. Indeed, the maximum of connexions from the 6lowPAN network can be computed and controlled if we know the topologie of the network. Otherwise, the internet client requests cannot be evaluated precisely and if the proxy is shutting down, we can imagine an other website proxy which takes its place from an other site, this is some reason which explains the choice to externalize the proxy on a simple webpage. We can addition the reason that this is a very easy way to developp a proxy with PHP language.<br/>
 <br/>
 The network is composed by :<br/>
 </p>
<div align="center">
<img src="EmmaNetwork.png" alt="EmmaNetwork.png"/>
</div>
<p> <a class="el" href="group___e_m_m_a___t_u_t_o_r_i_a_l_s.html#emmanode">E.M.M.A Node</a> publishes, notify and log the different ressources that it contains.<br/>
 <a class="el" href="group___e_m_m_a___t_u_t_o_r_i_a_l_s.html#gateway">R4ven Gateway</a> transmits packets from 6lowPAN format from/to IPV6 standard packets.<br/>
 <a class="el" href="group___e_m_m_a___t_u_t_o_r_i_a_l_s.html#emmaproxy">E.M.M.A Proxy</a> monitors all the registered node (All nodes which have a report to send to the proxy).<br/>
 <a class="el" href="group___e_m_m_a___t_u_t_o_r_i_a_l_s.html#emmaviewer">E.M.M.A Viewer</a> gets and draws datas extracted from emmaproxy. (E.M.M.A Viewer can directly access on the Emma Network if necessary)<br/>
</p>
<h2><a class="anchor" id="install">
How to install it</a></h2>
<h3><a class="anchor" id="emmanode">
E.M.M.A Node</a></h3>
<p>E.M.M.A Node is a physical entity which must contains the appropriate code of the plateform and the appropriate network configuration. E.M.M.A API is an easy way to developp a full E.M.M.A Application and the network configuration is realized throw the network itself.<br/>
</p>
<ul>
<li>E.M.M.A Node building : <br/>
 Only one file must be created for each plateform which are already ported on Contiki-2.x. In the directory /contiki-2.x/plateform/{MyPlateform}/Rest6-Agent.c, we must declare the different ressources and their drivers to use.<br/>
 Example : <div align="center">
<img src="EmmaAPI.png" alt="EmmaAPI.png"/>
</div>
 In this example, there are three different ressources, two are read-only and one read-writable. To start the application developpement, we must declare the sensors_list to be able to insert new ressources. After, the ressources must be declared and their driver implementations can be process. To activate the new ressource, we must associat a unit, a getter function and if it's writable a setter function.<br/>
 <br/>
 To compile it : <br/>
 go to /contiki-2.x/example/Emma-Rest6/, edit the Makefile and modify the plateform argument for your plateform : <div class="fragment"><pre class="fragment"> make -f Makefile.$(FORMAT) TARGET={Your Plateform} $(FORMAT).elf
</pre></div> And them, we compile it : <div class="fragment"><pre class="fragment"> make clean &amp;&amp; make all
</pre></div> To load on a ZigBit chips : <br/>
 <div class="fragment"><pre class="fragment"> meshprog -f Emma-Rest6.srec -t /dev/ttyUSB0 
</pre></div> Start wireshark to check network packets and try to ping it. If you can ping it, you must be able to acces it with your favorite web browser. (<a href="http://">http://</a>[IPV6 address of the node]/)</li>
</ul>
<ul>
<li>E.M.M.A Node network configuration :<br/>
 The network communication are based on the delegate task. To delegate a task to an other node, a mechanism of report by notification is periodically called and send request to other node or to a standard web server. Like our proxy is a standard web server, we can send a periodical request to the proxy. The proxy feedback reads instantaneous data, a log or all the log of the E.M.M.A node.<br/>
 <br/>
 A report can be attached on a specific ressource or on all the ressource, different condition of sending can be placed, like min or max value, time period or algebric condition (experimental).<br/>
 <br/>
 First, we must clear the report database by using Firefox's plugin POSTER or curl, with the request: <div class="fragment"><pre class="fragment"> DELETE /data<span class="comment">/*/report/*</span>
</pre></div> To check that the formating has successed : <div class="fragment"><pre class="fragment"> GET /data<span class="comment">/*/report/</span>
</pre></div> must return : <div class="fragment"><pre class="fragment"> []
</pre></div> Now, we can send our report request : <div class="fragment"><pre class="fragment"> POST /data/ { * | <a class="code" href="struct_ressource.html">Ressource</a> Name } /report/
 Body :
{
<span class="stringliteral">&quot;host&quot;</span>:<span class="stringliteral">&quot;[3ffe:0501:ffff:0100:0206:98ff:fe00:0231]&quot;</span>,
<span class="stringliteral">&quot;uri&quot;</span>:<span class="stringliteral">&quot;EMMA/proxy.php?get=notify&quot;</span>,
<span class="stringliteral">&quot;port&quot;</span>:<span class="stringliteral">&quot;80&quot;</span>,
<span class="stringliteral">&quot;method&quot;</span>:<span class="stringliteral">&quot;GET&quot;</span>,
<span class="stringliteral">&quot;body&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,
<span class="stringliteral">&quot;period&quot;</span>:<span class="stringliteral">&quot;100&quot;</span>,
<span class="stringliteral">&quot;min&quot;</span>:<span class="stringliteral">&quot;1000&quot;</span>,
<span class="stringliteral">&quot;max&quot;</span>:<span class="stringliteral">&quot;0&quot;</span>,
<span class="stringliteral">&quot;condition&quot;</span>:<span class="stringliteral">&quot;10&gt;4&quot;</span>
}
</pre></div> To check that the posting has successed : <div class="fragment"><pre class="fragment"> GET /data<span class="comment">/*/report/</span>
</pre></div> must return : <div class="fragment"><pre class="fragment">[{
<span class="stringliteral">&quot;host&quot;</span>:<span class="stringliteral">&quot;[3ffe:0501:ffff:0100:0206:98ff:fe00:0231]&quot;</span>,
<span class="stringliteral">&quot;uri&quot;</span>:<span class="stringliteral">&quot;EMMA/proxy.php?get=notify&quot;</span>,
<span class="stringliteral">&quot;id&quot;</span>:<span class="stringliteral">&quot;36&quot;</span>,
<span class="stringliteral">&quot;port&quot;</span>:<span class="stringliteral">&quot;80&quot;</span>,
<span class="stringliteral">&quot;method&quot;</span>:<span class="stringliteral">&quot;GET&quot;</span>,
<span class="stringliteral">&quot;body&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,
<span class="stringliteral">&quot;name&quot;</span>:<span class="stringliteral">&quot;*&quot;</span>,
<span class="stringliteral">&quot;period&quot;</span>:<span class="stringliteral">&quot;100&quot;</span>,
<span class="stringliteral">&quot;min&quot;</span>:<span class="stringliteral">&quot;1000&quot;</span>,
<span class="stringliteral">&quot;max&quot;</span>:<span class="stringliteral">&quot;0&quot;</span>,
<span class="stringliteral">&quot;condition&quot;</span>:<span class="stringliteral">&quot;10&gt;4&quot;</span>
}
]
</pre></div> The E.M.M.A node is ready and must try to send request on : <a href="http://">http://</a>[3ffe:0501:ffff:0100:0206:98ff:fe00:0231]/EMMA/proxy.php?get=notify</li>
</ul>
<h3><a class="anchor" id="gateway">
R4ven Gateway</a></h3>
<p>The R4ven Gateway allows the conversion between 6lowPAN packets and IPV6 standard packets and assume the coordination of the 802.15.4 network. To start and configure it, you can use the script Edge Router in tools directory. </p>
<div class="fragment"><pre class="fragment"> sudo -s
 chmod 755 <span class="stringliteral">&quot;Edge Router&quot;</span>
 ./Edge\ Router
</pre></div><p> The output result must be like : </p>
<div class="fragment"><pre class="fragment"> Configuration of the IP adress of the gateway
 Add route <span class="keywordflow">throw</span> the gateway USB0
 Activating IPV6 forwarding
 Starting Radvd forwarding IPV6 by sending global address by routing advertisement (RA)
</pre></div><p> Note: You must install radvd packet : apt-get install radvd <br/>
 To check, network configuration : </p>
<div class="fragment"><pre class="fragment"> ifconfig
 usb0      Link encap:Ethernet  HWaddr 02:12:13:00:10:00  
          adr inet6: fe80::12:13ff:fe00:1000/64 Scope:Lien
          adr inet6: 3ffe:501:ffff:100:206:98ff:fe00:231/128 Scope:Global
          UP BROADCAST RUNNING MULTICAST  MTU:1280  Metric:1
          Packets reçus:127 erreurs:127 :0 overruns:0 frame:127
          TX packets:56 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 lg file transmission:1000 
          Octets reçus:10994 (10.9 KB) Octets transmis:9158 (9.1 KB)
</pre></div><h3><a class="anchor" id="emmaproxy">
E.M.M.A Proxy</a></h3>
<p>E.M.M.A Proxy is composed of a PHP script and a SQL database. </p>
<ul>
<li>The SQL database is composed of two table : log and network. The datatable log contains all connexions and available datas of the client : traditionnal web client and E.M.M.A Node client.<br/>
 The contain of the table network are automically inserted and deleted by the proxy. This datatable contains the node actually connected with the proxy. We must create the database : <div class="fragment"><pre class="fragment">        SET SQL_MODE=<span class="stringliteral">&quot;NO_AUTO_VALUE_ON_ZERO&quot;</span>;
        --
        -- Structure de la table `log`
        --

        CREATE TABLE IF NOT EXISTS `log` (
          `<span class="keywordtype">id</span>` int(11) NOT NULL AUTO_INCREMENT,
          `address` text NOT NULL,
          `ressource` text NOT NULL,
          `unit` text NOT NULL,
          `time` bigint(20) NOT NULL,
          `value` <span class="keywordtype">int</span>(11) NOT NULL,
          PRIMARY KEY (`<span class="keywordtype">id</span>`)
        ) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=908 ;

        -- --------------------------------------------------------

        --
        -- Structure de la table `network`
        --

        CREATE TABLE IF NOT EXISTS `network` (
          `<span class="keywordtype">id</span>` <span class="keywordtype">int</span>(11) NOT NULL AUTO_INCREMENT,
          `address` text NOT NULL,
          `type` text NOT NULL,
          `state` text NOT NULL,
          `groupe` <span class="keywordtype">int</span>(11) NOT NULL,
          PRIMARY KEY (`<span class="keywordtype">id</span>`)
        ) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=18 ;
</pre></div> The sql connexion parameters must be edited in proxy.php : <div class="fragment"><pre class="fragment">function Emma_connection(){
$serv = mysql_connect(<span class="stringliteral">&quot;localhost&quot;</span>,<span class="stringliteral">&quot;root&quot;</span>,<span class="stringliteral">&quot;root&quot;</span>);
mysql_select_db(<span class="stringliteral">&quot;Emma-site&quot;</span>,$serv);
}
</pre></div> The file proxy.php must be placed at the URI define during E.M.M.A Node configuration step (/EMMA/proxy.php).<br/>
 To check, if an E.M.M.A Node is already connected for updating datatable, the proxy must send periodically ping request.<br/>
 There are different way to do that, the most easy way is to use Cron linux daemon.<br/>
 We will use cron for sending ping request on E.M.M.A Node registered and updating their state.<br/>
 <br/>
 You must install php5-cli package : apt-get install php5-cli Note : there is a bug in Lucid ubuntu, you must replace # by ; in the file /etc/php5/cli/conf.d/mcrypt.ini <div class="fragment"><pre class="fragment">crontab -e
 * * * * php -f /var/www/EMMA-view/proxy.php <span class="keyword">get</span>=ping &gt; /var/www/EMMA-view/Network.log
</pre></div> Now, the proxy is installed, we can test it with the uri : <div class="fragment"><pre class="fragment"><span class="comment">// Get all logs</span>
GET http:<span class="comment">//127.0.0.1/EMMA/proxy.php?get=log</span>

<span class="comment">// Get log from a specific node</span>
GET http:<span class="comment">//127.0.0.1/EMMA/proxy.php?get=log&amp;&amp;address=XXXX::XXXX:XXXX:XXXX:XXXX</span>

<span class="comment">// Get log of a ressource from a specific node</span>
GET http:<span class="comment">//127.0.0.1/EMMA/proxy.php?get=log&amp;&amp;address=XXXX::XXXX:XXXX:XXXX:XXXX&amp;&amp;ressource=MyRessource</span>
</pre></div></li>
</ul>
<h3><a class="anchor" id="emmaviewer">
E.M.M.A Viewer</a></h3>
<p>The E.M.M.A Viewer is a simple javascript client to browse and print chart of network data.<br/>
 On the left of the screen, there are two section, the first contains all registered E.M.M.A Node if there are actually connected, there are appeared in green otherwise in red. By clicking on a specific node, the chart prints all ressources contained.<br/>
 The second section allows us to print simply a specific ressource on the chart.<br/>
 <br/>
 To configure the client, you must specify the uri of the proxy </p>
<div class="fragment"><pre class="fragment">var uri_proxy = <span class="stringliteral">&#39;proxy.php&#39;</span>;
</pre></div> <div align="center">
<img src="EmmaViewer.png" alt="EmmaViewer.png"/>
</div>
<p> <br/>
 Enjoy your E.M.M.A network ;-)<br/>
 / </p>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Jun 30 18:40:31 2010 for EMMA by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
